"use strict";var e=/^[a-z_-][a-z\d_-]*$/i;function t(t){return"string"==typeof t&&""!==t&&e.test(t)}var i={selectorImmerser:"[data-immerser]",selectorLayer:"[data-immerser-layer]",selectorSolid:"[data-immerser-solid]",selectorPager:"[data-immerser-pager]",selectorPagerLink:"[data-immerser-state-index]",selectorMask:"[data-immerser-mask]",selectorMaskInner:"[data-immerser-mask-inner]",selectorSynchroHover:"[data-immerser-synchro-hover]"},o={solidClassnameArray:{initial:[],description:"non empty array of objects",validator:function(e){return Array.isArray(e)&&0!==e.length}},fromViewportWidth:{initial:1024,description:"a natural number",validator:function(e){return"number"==typeof e&&0<=e&&e%1==0}},pagerThreshold:{initial:.5,description:"a number between 0 and 1",validator:function(e){return"number"==typeof e&&0<=e&&e<=1}},hasToUpdateHash:{initial:!1,description:"boolean",validator:function(e){return"boolean"==typeof e}},scrollAdjustThreshold:{initial:0,description:"a number greater than or equal to 0",validator:function(e){return"number"==typeof e&&e>=0}},scrollAdjustDelay:{initial:600,description:"a number greater than or equal to 300",validator:function(e){return"number"==typeof e&&e>=300}},classnamePager:{initial:"pager",description:"valid non empty classname string",validator:t},classnamePagerLink:{initial:"pager__link",description:"valid non empty classname string",validator:t},classnamePagerLinkActive:{initial:"pager__link--active",description:"valid non empty classname string",validator:t},onInit:{initial:null,description:"function",validator:function(e){return"function"==typeof e}},onBind:{initial:null,description:"function",validator:function(e){return"function"==typeof e}},onUnbind:{initial:null,description:"function",validator:function(e){return"function"==typeof e}},onDestroy:{initial:null,description:"function",validator:function(e){return"function"==typeof e}},onActiveLayerChange:{initial:null,description:"function",validator:function(e){return"function"==typeof e}}},r=function(e){var t=e&&e.hasOwnProperty("initial")?e.initial:void 0,i=e&&e.hasOwnProperty("onChange")?e.onChange:void 0;return{internal:t,callbacks:"function"==typeof i?[i]:[],get onChange(){return this.callbacks},set onChange(e){if("function"!=typeof e)throw new Error("[createObservable] callback must be a function.");this.callbacks.push(e)},get value(){return this.internal},set value(e){if(e!==this.internal){var t=this.internal;this.internal=e;for(let e=0;e<this.callbacks.length;e++)this.callbacks[e](this.internal,t)}}}};function n(e){return null!==e&&"object"==typeof e&&!1===Array.isArray(e)}function s(e,t){for(var i in t)e.style[i]=t[i]}function a(e,t){for(var i=0;i<e.length;i++)t(e[i],i,e)}function l(e,t,i){return Math.max(Math.min(e,i),t)}function c(){var e=window.scrollX||document.documentElement.scrollLeft,t=window.scrollY||document.documentElement.scrollTop;return{x:l(e,0,document.documentElement.offsetWidth),y:l(t,0,document.documentElement.offsetHeight)}}var d=function(e){this.initState(),this.init(e)};d.prototype.initState=function(){this.options=Object.assign({},i),this.statemap=[],this.isBound=!1,this.isCustomMarkup=!1,this.immerserNode=null,this.pagerNode=null,this.originalChildrenNodeList=null,this.immerserMaskNodeArray=[],this.synchroHoverNodeArray=[],this.documentHeight=0,this.windowHeight=0,this.immerserTop=0,this.immerserHeight=0,this.resizeTimerId=null,this.scrollTimerId=null,this.reactiveSynchroHoverId=r(),this.reactiveActiveLayer=r(),this.reactiveWindowWidth=r(),this.onResize=null,this.onScroll=null},d.prototype.init=function(e){this.options=Object.assign({},this.options,function(e){var t=e.defaults,i=e.userOptions;void 0===i&&(i={});var o=e.warnPreffix;void 0===o&&(o="");var r=e.warnSuffix;if(void 0===r&&(r=""),!n(t))throw new TypeError("Expected defaults is required not null, not array object, got "+typeof t+" "+t);if(Object.keys(t).map(function(e){return{key:e,option:t[e]}}).forEach(function(e){var t=e.key,i=e.option;if(!n(i))throw new TypeError("Expected each default option is an object, got "+t+" is "+typeof i+" "+i);if(!Object.prototype.hasOwnProperty.call(i,"initial"))throw new TypeError("Expected "+t+" have initial property");if(!Object.prototype.hasOwnProperty.call(i,"description"))throw new TypeError("Expected "+t+" have description property");var o=i.description;if("string"!=typeof o)throw new TypeError("Expected "+t+" description is a string, got "+typeof o+" "+o);if(!Object.prototype.hasOwnProperty.call(i,"validator"))throw new TypeError("Expected "+t+" have validator property");var r=i.validator;if("function"!=typeof r)throw new TypeError("Expected "+t+" validator is a function, got "+typeof r+" "+r)}),!n(i))throw new TypeError("Expected userOptions is required not null, not array object, got "+typeof i+" "+i);if(void 0!==o&&"string"!=typeof o)throw new TypeError("Expected warnPreffix is optional string, got "+typeof o+" "+o);if(void 0!==r&&"string"!=typeof r)throw new TypeError("Expected warnSuffix is optional string, got "+typeof r+" "+r);var s={};for(var a in t){var l=t[a],c=l.initial,d=l.description,h=l.validator;if(s[a]=c,Object.prototype.hasOwnProperty.call(i,a)){var u=i[a];h(u)?s[a]=u:console.warn(o,"Expected "+a+" is "+d+", got "+typeof u+" "+u+".","Fallback to default value "+c+".",r)}}return s}({defaults:o,userOptions:e,warnPreffix:"immerser:",warnSuffix:"Check out documentation https://github.com/dubaua/immerser#options"})),this.immerserNode=document.querySelector(this.options.selectorImmerser),this.immerserNode?(this.initStatemap(),this.setSizes(),this.onScroll=this.handleScroll.bind(this),this.onResize=this.handleResize.bind(this),window.addEventListener("scroll",this.onScroll,!1),window.addEventListener("resize",this.onResize,!1),"function"==typeof this.options.onInit&&this.options.onInit(this)):console.warn("immerser: immerser element not found. Check out documentation https://github.com/dubaua/immerser#how-to-use")},d.prototype.initStatemap=function(){var e=this;a(document.querySelectorAll(this.options.selectorLayer),function(t,i){var o=e.options.solidClassnameArray[i];if(t.dataset.immerserLayerConfig)try{o=JSON.parse(t.dataset.immerserLayerConfig)}catch(e){console.error("Failed to parse JSON class configuration.",e)}var r=t.id;r||(t.id=r="immerser-section-"+i,t.__immerserCustomId=!0),e.statemap.push({node:t,id:r,solidClassnames:o,top:0,bottom:0})})},d.prototype.setSizes=function(){var e=this;this.documentHeight=document.documentElement.offsetHeight,this.windowHeight=window.innerHeight,this.immerserTop=this.immerserNode.offsetTop,this.immerserHeight=this.immerserNode.offsetHeight,this.statemap=this.statemap.map(function(e){var t=e.node.offsetTop;return Object.assign({},e,{top:t,bottom:t+e.node.offsetHeight})}),this.statemap=this.statemap.map(function(t,i){var o=0===i,r=i===e.statemap.length-1,n=o?0:e.statemap[i-1].bottom-e.immerserTop,s=r?e.documentHeight:e.statemap[i].bottom-e.immerserTop;return Object.assign({},t,{startEnter:o?0:n-e.immerserHeight,enter:n,startLeave:r?e.documentHeight:s-e.immerserHeight,leave:s})}),this.reactiveWindowWidth.onChange=function(t){t>=e.options.fromViewportWidth?e.isBound||e.bind():e.isBound&&e.unbind()},this.reactiveWindowWidth.value=window.innerWidth},d.prototype.initPager=function(){var e=this;this.reactiveActiveLayer.onChange=function(t){e.isBound&&(e.drawPagerLinks(t),e.options.hasToUpdateHash&&e.updateHash(t),"function"==typeof e.options.onActiveLayerChange&&e.options.onActiveLayerChange(t,e))}},d.prototype.createPagerLinks=function(){var e=this,t=this.options,i=t.classnamePagerLink;this.pagerNode.classList.add(t.classnamePager),this.statemap.forEach(function(t,o){var r=document.createElement("a");r.classList.add(i),r.href="#"+t.id,r.dataset.immerserStateIndex=o,r.dataset.immerserSynchroHover="pager-link-"+o,e.pagerNode.appendChild(r),t.pagerLinkNodeArray=[]})},d.prototype.initPagerLinks=function(){var e=this;a(this.immerserNode.querySelectorAll(this.options.selectorPagerLink),function(t){e.statemap[t.dataset.immerserStateIndex].pagerLinkNodeArray.push(t)})},d.prototype.initHoverSynchro=function(e){var t=this;this.reactiveSynchroHoverId.onChange=function(e){t.drawSynchroHover(e)},a(e,function(e){var i=function(e){t.reactiveSynchroHoverId.value=e.target.dataset.immerserSynchroHover};e.addEventListener("mouseover",i),e.__immerserHandleMouseOver=i;var o=function(){t.reactiveSynchroHoverId.value=void 0};e.addEventListener("mouseout",o),e.__immerserHandleMouseOut=o,t.synchroHoverNodeArray.push(e)})},d.prototype.createMasks=function(){var e=this,t={position:"absolute",top:0,right:0,bottom:0,left:0,overflow:"hidden"};this.originalChildrenNodeList=this.immerserNode.querySelectorAll(this.options.selectorSolid),s(this.immerserNode,{pointerEvents:"none",touchAction:"none"});var i=this.immerserNode.querySelectorAll(this.options.selectorMask);this.isCustomMarkup=i.length===this.statemap.length,i.length>0&&i.length!==this.statemap.length&&console.warn("immerser: You're trying use custom markup, but count of your immerser masks doesn't equal layers count. Check out documentation https://github.com/dubaua/immerser#custom-markup"),a(i,function(t){for(var i=t.querySelector(e.options.selectorMaskInner).children,o=0;o<i.length;o++)s(i[o],{pointerEvents:"all",touchAction:"auto"})}),this.statemap=this.statemap.map(function(o,r){var n=e.isCustomMarkup?i[r]:document.createElement("div");s(n,t);var l=e.isCustomMarkup?n.querySelector(e.options.selectorMaskInner):document.createElement("div");return s(l,t),a(e.originalChildrenNodeList,function(e){var t=e.cloneNode(!0);s(t,{pointerEvents:"all",touchAction:"auto"}),t.immerserClonned=!0,l.appendChild(t)}),a(l.querySelectorAll(e.options.selectorSolid),function(e){var t=e.dataset.immerserSolid;o.solidClassnames&&o.solidClassnames.hasOwnProperty(t)&&e.classList.add(o.solidClassnames[t])}),0!==r&&n.setAttribute("aria-hidden","true"),n.appendChild(l),e.immerserNode.appendChild(n),e.immerserMaskNodeArray.push(n),Object.assign({},o,{maskNode:n,maskInnerNode:l})}),a(this.originalChildrenNodeList,function(t){e.immerserNode.removeChild(t)})},d.prototype.bind=function(){this.pagerNode=document.querySelector(this.options.selectorPager),this.pagerNode&&(this.initPager(),this.createPagerLinks()),this.createMasks(),this.pagerNode&&this.initPagerLinks();var e=document.querySelectorAll(this.options.selectorSynchroHover);e.length&&this.initHoverSynchro(e),"function"==typeof this.options.onBind&&this.options.onBind(this),this.isBound=!0,this.draw(),this.pagerNode&&this.drawPagerLinks(this.reactiveActiveLayer.value)},d.prototype.unbind=function(){var e=this;this.synchroHoverNodeArray.forEach(function(e){e.removeEventListener("mouseover",e.__immerserHandleMouseOver),e.removeEventListener("mouseout",e.__immerserHandleMouseOut)}),this.statemap.forEach(function(e){e.pagerLinkNodeArray=[],e.node.__immerserCustomId&&e.node.removeAttribute("id")}),a(this.originalChildrenNodeList,function(t){e.immerserNode.appendChild(t)}),this.immerserMaskNodeArray.forEach(function(t){if(e.isCustomMarkup){t.removeAttribute("style"),t.removeAttribute("aria-hidden");var i=t.querySelector(e.options.selectorMaskInner);i.removeAttribute("style"),a(i.querySelectorAll(e.options.selectorSolid),function(e){e.immerserClonned&&i.removeChild(e)})}else e.immerserNode.removeChild(t)}),this.pagerNode.innerHTML="","function"==typeof this.options.onUnbind&&this.options.onUnbind(this),this.isBound=!1,this.reactiveActiveLayer.value=void 0},d.prototype.destroy=function(){this.unbind(),window.removeEventListener("scroll",this.onScroll,!1),window.removeEventListener("resize",this.onResize,!1),"function"==typeof this.options.onDestroy&&this.options.onDestroy(this),this.initState()},d.prototype.draw=function(){var e=this,t=c().y;this.statemap.forEach(function(i,o){var r,n=i.startEnter,s=i.enter,a=i.startLeave,l=i.leave,c=i.maskInnerNode,d=i.top,h=i.bottom;if(n>t?r=e.immerserHeight:n<=t&&t<s?r=s-t:s<=t&&t<a?r=0:a<=t&&t<l?r=a-t:t>=l&&(r=-e.immerserHeight),i.maskNode.style.transform="translateY("+r+"px)",c.style.transform="translateY("+-r+"px)",e.pagerNode){var u=t+e.windowHeight*(1-e.options.pagerThreshold);d<=u&&u<h&&(e.reactiveActiveLayer.value=o)}})},d.prototype.drawPagerLinks=function(){var e=this;this.statemap.forEach(function(t){t.pagerLinkNodeArray.forEach(function(t){parseInt(t.dataset.immerserStateIndex,10)===e.reactiveActiveLayer.value?t.classList.add(e.options.classnamePagerLinkActive):t.classList.remove(e.options.classnamePagerLinkActive)})})},d.prototype.drawSynchroHover=function(e){this.synchroHoverNodeArray.forEach(function(t){t.dataset.immerserSynchroHover===e?t.classList.add("_hover"):t.classList.remove("_hover")})},d.prototype.updateHash=function(e){var t=this.statemap[e],i=t.id;t.node.removeAttribute("id"),window.location.hash=i,t.node.setAttribute("id",i)},d.prototype.adjustScroll=function(){var e=this.statemap[this.reactiveActiveLayer.value],t=e.top,i=e.bottom,o=c(),r=o.x,n=o.y,s=Math.abs(n-t),a=Math.abs(n+this.windowHeight-i);0!==s&&0!==a&&(s<=a&&s<=this.options.scrollAdjustThreshold?window.scrollTo(r,t):a<=s&&a<=this.options.scrollAdjustThreshold&&window.scrollTo(r,i-this.windowHeight))},d.prototype.handleScroll=function(){var e=this;this.isBound&&(this.draw(),this.options.hasToUpdateHash&&this.options.scrollAdjustThreshold>0&&(this.scrollTimerId&&clearTimeout(this.scrollTimerId),this.scrollTimerId=setTimeout(function(){e.adjustScroll()},this.options.scrollAdjustDelay)))},d.prototype.handleResize=function(){var e=this;this.resizeTimerId&&window.cancelAnimationFrame(this.resizeTimerId),this.resizeTimerId=window.requestAnimationFrame(function(){e.setSizes(),e.draw()})},module.exports=d;
//# sourceMappingURL=immerser.min.js.map
