"use strict";var e=/^[a-z_-][a-z\d_-]*$/i;function t(t){return"string"==typeof t&&""!==t&&e.test(t)}var i={_selectorImmerser:"[data-immerser]",_selectorLayer:"[data-immerser-layer]",_selectorSolid:"[data-immerser-solid]",_selectorPager:"[data-immerser-pager]",_selectorPagerLink:"[data-immerser-state-index]",_selectorMask:"[data-immerser-mask]",_selectorMaskInner:"[data-immerser-mask-inner]",_selectorSynchroHover:"[data-immerser-synchro-hover]",solidClassnameArray:{defaultValue:[],description:"non empty array of objects",validator:function(e){return Array.isArray(e)&&0!==e.length}},fromViewportWidth:{defaultValue:1024,description:"a natural number",validator:function(e){return"number"==typeof e&&0<=e&&e%1==0}},pagerTreshold:{defaultValue:.5,description:"a number between 0 and 1",validator:function(e){return"number"==typeof e&&0<=e&&e<=1}},hasToUpdateHash:{defaultValue:!1,description:"boolean",validator:function(e){return"boolean"==typeof e}},classnamePager:{defaultValue:"pager",description:"valid non empty classname string",validator:t},classnamePagerLink:{defaultValue:"pager__link",description:"valid non empty classname string",validator:t},classnamePagerLinkActive:{defaultValue:"pager__link--active",description:"valid non empty classname string",validator:t},onInit:{defaultValue:null,description:"function",validator:function(e){return"function"==typeof e}},onBind:{defaultValue:null,description:"function",validator:function(e){return"function"==typeof e}},onUnbind:{defaultValue:null,description:"function",validator:function(e){return"function"==typeof e}},onDestroy:{defaultValue:null,description:"function",validator:function(e){return"function"==typeof e}},onActiveLayerChange:{defaultValue:null,description:"function",validator:function(e){return"function"==typeof e}}};function o(e,t){for(var i in t)e.style[i]=t[i]}function r(e,t){for(var i=0;i<e.length;i++)t(e[i],i,e)}function n(e,t){return{internal:t,callbacks:"function"==typeof e?[e]:[],get onChange(){return this.callbacks},set onChange(e){"function"==typeof e&&this.callbacks.push(e)},get value(){return this.internal},set value(e){if(e!==this.internal){this.internal=e;for(var t=0;t<this.callbacks.length;t++)this.callbacks[t](this.internal)}}}}var s=function(e){this.defaults=i,this.initState(),this.init(e)};s.prototype.initState=function(){this.options={},this.statemap=[],this.isBound=!1,this.isCustomMarkup=!1,this.immerserNode=null,this.pagerNode=null,this.originalChildrenNodeList=null,this.immerserMaskNodeArray=[],this.synchroHoverNodeArray=[],this.documentHeight=0,this.windowHeight=0,this.immerserTop=0,this.immerserHeight=0,this.resizeTimerId=null,this.reactiveSynchroHoverId=n(),this.reactiveActiveLayer=n(),this.reactiveWindowWidth=n(),this.onResize=null,this.onScroll=null},s.prototype.init=function(e){this.mergeOptions(e),this.immerserNode=document.querySelector(this.options._selectorImmerser),this.immerserNode?(this.initStatemap(),this.setSizes(),this.onScroll=this.handleScroll.bind(this),this.onResize=this.handleResize.bind(this),window.addEventListener("scroll",this.onScroll,!1),window.addEventListener("resize",this.onResize,!1),"function"==typeof this.options.onInit&&this.options.onInit(this)):console.warn("Immerser element not found. Check out documentation https://github.com/dubaua/immerser#how-to-use")},s.prototype.mergeOptions=function(e){for(var t in void 0===e&&(e={}),this.defaults)if("function"!=typeof this.defaults[t].validator)this.options[t]=this.defaults[t];else{var i=this.defaults[t],o=i.defaultValue,r=i.description,n=i.validator;if(this.options[t]=o,e.hasOwnProperty(t)){var s=e[t];n(s)?this.options[t]=s:console.warn("Expected "+t+" is "+r+", got <"+typeof s+"> "+s+". Fallback to default value "+o+". Check documentation https://github.com/dubaua/immerser#options")}}},s.prototype.initStatemap=function(){var e=this;r(document.querySelectorAll(this.options._selectorLayer),function(t,i){var o=e.options.solidClassnameArray[i];if(t.dataset.immerserLayerConfig)try{o=JSON.parse(t.dataset.immerserLayerConfig)}catch(e){console.error("Failed to parse JSON class configuration.",e)}var r=t.id;r||(t.id=r="immerser-section-"+i,t.__immerserCustomId=!0),e.statemap.push({node:t,id:r,solidClassnames:o,top:0,bottom:0})})},s.prototype.setSizes=function(){var e=this;this.documentHeight=document.documentElement.offsetHeight,this.windowHeight=window.innerHeight,this.immerserTop=this.immerserNode.offsetTop,this.immerserHeight=this.immerserNode.offsetHeight,this.statemap=this.statemap.map(function(e){var t=e.node.offsetTop;return Object.assign({},e,{top:t,bottom:t+e.node.offsetHeight})}),this.statemap=this.statemap.map(function(t,i){var o=0===i,r=i===e.statemap.length-1,n=o?0:e.statemap[i-1].bottom-e.immerserTop,s=r?e.documentHeight:e.statemap[i].bottom-e.immerserTop;return Object.assign({},t,{startEnter:o?0:n-e.immerserHeight,enter:n,startLeave:r?e.documentHeight:s-e.immerserHeight,leave:s})}),this.reactiveWindowWidth.onChange=function(t){t>=e.options.fromViewportWidth?e.isBound||e.bind():e.isBound&&e.unbind()},this.reactiveWindowWidth.value=window.innerWidth},s.prototype.initPager=function(){var e=this;this.reactiveActiveLayer.onChange=function(t){e.isBound&&(e.drawPagerLinks(t),e.options.hasToUpdateHash&&e.updateHash(t),"function"==typeof e.options.onActiveLayerChange&&e.options.onActiveLayerChange(t,e))}},s.prototype.createPagerLinks=function(){var e=this,t=this.options,i=t.classnamePagerLink;this.pagerNode.classList.add(t.classnamePager),this.statemap.forEach(function(t,o){var r=document.createElement("a");r.classList.add(i),r.href="#"+t.id,r.dataset.immerserStateIndex=o,r.dataset.immerserSynchroHover="pager-link-"+o,e.pagerNode.appendChild(r),t.pagerLinkNodeArray=[]})},s.prototype.initPagerLinks=function(){var e=this;r(this.immerserNode.querySelectorAll(this.options._selectorPagerLink),function(t){e.statemap[t.dataset.immerserStateIndex].pagerLinkNodeArray.push(t)})},s.prototype.initHoverSynchro=function(e){var t=this;this.reactiveSynchroHoverId.onChange=function(e){t.drawSynchroHover(e)},r(e,function(e){var i=function(e){t.reactiveSynchroHoverId.value=e.target.dataset.immerserSynchroHover};e.addEventListener("mouseover",i),e.__immerserHandleMouseOver=i;var o=function(){t.reactiveSynchroHoverId.value=void 0};e.addEventListener("mouseout",o),e.__immerserHandleMouseOut=o,t.synchroHoverNodeArray.push(e)})},s.prototype.createMasks=function(){var e=this,t={position:"absolute",top:0,right:0,bottom:0,left:0,overflow:"hidden"};this.originalChildrenNodeList=this.immerserNode.querySelectorAll(this.options._selectorSolid),o(this.immerserNode,{pointerEvents:"none",touchAction:"none"});var i=this.immerserNode.querySelectorAll(this.options._selectorMask);this.isCustomMarkup=i.length===this.statemap.length,i.length>0&&i.length!==this.statemap.length&&console.warn("You're trying use custom markup, but count of your immerser masks doesn't equal layers count."),r(i,function(t){for(var i=t.querySelector(e.options._selectorMaskInner).children,r=0;r<i.length;r++)o(i[r],{pointerEvents:"all",touchAction:"auto"})}),this.statemap=this.statemap.map(function(n,s){var a=e.isCustomMarkup?i[s]:document.createElement("div");o(a,t);var d=e.isCustomMarkup?a.querySelector(e.options._selectorMaskInner):document.createElement("div");return o(d,t),r(e.originalChildrenNodeList,function(e){var t=e.cloneNode(!0);o(t,{pointerEvents:"all",touchAction:"auto"}),t.immerserClonned=!0,d.appendChild(t)}),r(d.querySelectorAll(e.options._selectorSolid),function(e){var t=e.dataset.immerserSolid;n.solidClassnames&&n.solidClassnames.hasOwnProperty(t)&&e.classList.add(n.solidClassnames[t])}),0!==s&&a.setAttribute("aria-hidden","true"),a.appendChild(d),e.immerserNode.appendChild(a),e.immerserMaskNodeArray.push(a),Object.assign({},n,{maskNode:a,maskInnerNode:d})}),r(this.originalChildrenNodeList,function(t){e.immerserNode.removeChild(t)})},s.prototype.bind=function(){this.pagerNode=document.querySelector(this.options._selectorPager),this.pagerNode&&(this.initPager(),this.createPagerLinks()),this.createMasks(),this.pagerNode&&this.initPagerLinks();var e=document.querySelectorAll(this.options._selectorSynchroHover);e.length&&this.initHoverSynchro(e),"function"==typeof this.options.onBind&&this.options.onBind(this),this.isBound=!0,this.draw(),this.drawPagerLinks(this.reactiveActiveLayer.value)},s.prototype.unbind=function(){var e=this;this.synchroHoverNodeArray.forEach(function(e){e.removeEventListener("mouseover",e.__immerserHandleMouseOver),e.removeEventListener("mouseout",e.__immerserHandleMouseOut)}),this.statemap.forEach(function(e){e.pagerLinkNodeArray=[],e.node.__immerserCustomId&&e.node.removeAttribute("id")}),r(this.originalChildrenNodeList,function(t){e.immerserNode.appendChild(t)}),this.immerserMaskNodeArray.forEach(function(t){if(e.isCustomMarkup){t.removeAttribute("style"),t.removeAttribute("aria-hidden");var i=t.querySelector(e.options._selectorMaskInner);i.removeAttribute("style"),r(i.querySelectorAll(e.options._selectorSolid),function(e){e.immerserClonned&&i.removeChild(e)})}else e.immerserNode.removeChild(t)}),this.pagerNode.innerHTML="","function"==typeof this.options.onUnbind&&this.options.onUnbind(this),this.isBound=!1,this.reactiveActiveLayer.value=void 0},s.prototype.destroy=function(){this.unbind(),window.removeEventListener("scroll",this.onScroll,!1),window.removeEventListener("resize",this.onResize,!1),"function"==typeof this.options.onDestroy&&this.options.onDestroy(this),this.initState()},s.prototype.draw=function(){var e,t=this,i=(e=window.scrollY||document.documentElement.scrollTop,Math.min(Math.max(e,0),document.documentElement.offsetHeight));this.statemap.forEach(function(e,o){var r,n=e.startEnter,s=e.enter,a=e.startLeave,d=e.leave,l=e.maskInnerNode,c=e.top,h=e.bottom;if(n>i?r=t.immerserHeight:n<=i&&i<s?r=s-i:s<=i&&i<a?r=0:a<=i&&i<d?r=a-i:i>=d&&(r=-t.immerserHeight),e.maskNode.style.transform="translateY("+r+"px)",l.style.transform="translateY("+-r+"px)",t.pagerNode){var u=i+t.windowHeight*(1-t.options.pagerTreshold);c<=u&&u<h&&(t.reactiveActiveLayer.value=o)}})},s.prototype.drawPagerLinks=function(){var e=this;this.statemap.forEach(function(t){t.pagerLinkNodeArray.forEach(function(t){parseInt(t.dataset.immerserStateIndex,10)===e.reactiveActiveLayer.value?t.classList.add(e.options.classnamePagerLinkActive):t.classList.remove(e.options.classnamePagerLinkActive)})})},s.prototype.drawSynchroHover=function(e){this.synchroHoverNodeArray.forEach(function(t){t.dataset.immerserSynchroHover===e?t.classList.add("_hover"):t.classList.remove("_hover")})},s.prototype.updateHash=function(e){var t=this.statemap[e],i=t.id;t.node.removeAttribute("id"),window.location.hash=i,t.node.setAttribute("id",i)},s.prototype.handleScroll=function(){this.isBound&&this.draw()},s.prototype.handleResize=function(){var e=this;this.resizeTimerId&&window.cancelAnimationFrame(this.resizeTimerId),this.resizeTimerId=window.requestAnimationFrame(function(){e.setSizes(),e.draw()})},module.exports=s;
//# sourceMappingURL=immerser.min.js.map
